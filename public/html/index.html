<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liceo UDP - Consultas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arimo:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Secular+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
</head>
<body>
<div class="container my-5">
    <!-- Encabezado -->
    <header class="text-center py-4 bg-danger text-white rounded">
        <h1 class="fw-bold">LICEO UDP</h1>
        <p class="mb-0">Consulta y gestiona la información de nuestra base de datos.</p>
    </header>

    <!-- Formulario -->
    <section class="mt-4">
        <h2 class="text-center text-danger mb-3">Consultas</h2>
        <form id="consultaForm" class="bg-light p-4 rounded shadow">
            <div class="mb-3">
                <label for="consulta" class="form-label">Seleccione una consulta:</label>
                <select class="form-select" id="consulta" name="consulta" required>
                    <option value="1">Nombres de profesores que imparten inglés</option>
                    <option value="2">Alumnos con promedio menor a 5.0</option>
                    <option value="3">Promedio de notas por curso</option>
                    <option value="4">Nombres de profesores que imparten lenguaje</option>
                    <option value="5">Horario en el que se imparte el ramo de Matemáticas</option>
                    <option value="6">Nombre y curso de alumnos que tienen notas sobre 6.0</option>
                    <option value="7">Nombre de alumnos que tienen menos del 50% de asistencia</option>
                    <option value="8">Porcentaje de asistencia de profesores de matemática</option>
                    <option value="9">Nombres de los alumnos que tienen entre 5 y 10 años</option>
                    <option value="10">Teléfono del apoderado de un alumno según su RUT</option>
                    <option value="11">Obtener el promedio de notas por materia de cada alumno</option>
                    <option value="12">Nombre del curso con mejor promedio</option>
                    <option value="13">Cursos que tienen al menos un alumno con nota bajo 4.0</option>
                    <option value="14">Un listado de los profesores y qué materia imparte cada uno</option>
                    <option value="15">Nombres de los profesores con peor asistencia</option>
                </select>
            </div>
            <button type="submit" class="btn btn-danger w-100">Ejecutar Consulta</button>
        </form>
    </section>

    <!-- Spinner -->
    <div id="spinner" class="d-none text-center mt-4">
        <div class="spinner-border text-danger" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p>Cargando consulta, por favor espere...</p>
    </div>

    <!-- Resultados -->
    <section class="mt-5">
        <h2 class="text-center text-danger mb-3">Resultados</h2>
        <table class="table table-bordered table-striped shadow">
            <thead class="bg-danger text-white">
            <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </section>
</div>

<script>
    const form = document.getElementById('consultaForm');
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    const spinner = document.getElementById('spinner'); // Referencia al spinner

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Mostrar el spinner
        spinner.classList.remove('d-none');
        tableBody.innerHTML = ''; // Limpiar resultados previos

        const consulta = document.getElementById('consulta').value;

        try {
            const response = await fetch('/consultas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ consulta }),
            });

            if (!response.ok) throw new Error('Error al ejecutar la consulta.');

            const data = await response.json();
            mostrarResultados(data);
        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="3" class="text-danger">${error.message}</td></tr>`;
        } finally {
            // Ocultar el spinner
            spinner.classList.add('d-none');
        }
    });

    function mostrarResultados(data) {
        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';

        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3">No se encontraron resultados.</td></tr>';
            return;
        }

        const keys = Object.keys(data[0]);
        keys.forEach((key) => {
            const th = document.createElement('th');
            th.textContent = key;
            tableHeader.appendChild(th);
        });

        data.forEach((row) => {
            const tr = document.createElement('tr');
            Object.values(row).forEach((value) => {
                const td = document.createElement('td');
                td.textContent = value;
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }
</script>
</body>
</html>
